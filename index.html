<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://unpkg.com/tone@latest/build/Tone.js"></script>
</head>
<body style="height:100vh; margin:0; background:#222; color:white; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:sans-serif;">
<h2>ğŸµ Interactive Music Generator ğŸµ</h2>
<p>â¬…ï¸ Simple &nbsp;&nbsp;&nbsp;&nbsp; ğŸ­ Mouse X Position ğŸ­ &nbsp;&nbsp;&nbsp;&nbsp; Dance â¡ï¸</p>
<p style="color:#aaa; font-size:0.8em;">Click anywhere to Start</p>

<script>
// ===============================
// 1. ã‚³ãƒ¼ãƒ‰é€²è¡Œï¼ˆCãƒ¡ã‚¸ãƒ£ãƒ¼ 8å°ç¯€ï¼‰
// ===============================
const chords = [
  ["C3","E3","G3"], ["B2","D3","G3"], ["A2","C3","E3"], ["G2","B2","E3"],
  ["F2","A2","C3"], ["E2","G2","C3"], ["F2","A2","C3"], ["G2","B2","D3"]
];

const scales = [
  ["C4","D4","E4","G4","A4"], ["B3","D4","G4","A4","B4"],
  ["A3","C4","E4","G4","A4"], ["G3","B3","E4","G4","B4"],
  ["F3","A3","C4","F4","G4"], ["E3","G3","C4","E4","G4"],
  ["F3","A3","C4","F4","A4"], ["G3","B3","D4","G4","A4"]
];

// ===============================
// 2. ãƒã‚¦ã‚¹åº§æ¨™å–å¾—
// ===============================
let activity = 0;   // 0.0(å·¦) ã€œ 1.0(å³)
let heightBias = 0; // 0.0(ä¸Š) ã€œ 1.0(ä¸‹)

document.addEventListener("mousemove", (e)=>{
  activity = e.clientX / window.innerWidth;
  heightBias = e.clientY / window.innerHeight;
});

// ===============================
// 3. æ¥½å™¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
// ===============================
// ã‚³ãƒ¼ãƒ‰
const chordSynth = new Tone.PolySynth(Tone.Synth, { volume: -10 }).toDestination();

// ãƒ¡ãƒ­ãƒ‡ã‚£
const melodySynth = new Tone.Synth({ 
  oscillator: { type: "triangle" }, 
  volume: -2 
}).toDestination();

// --- ãƒ‰ãƒ©ãƒ ã‚»ãƒƒãƒˆ ---
const kick = new Tone.MembraneSynth({ volume: -4 }).toDestination();

const snare = new Tone.NoiseSynth({ 
  volume: -12, 
  envelope: { attack: 0.001, decay: 0.2, sustain: 0 } 
}).toDestination();

const hihat = new Tone.MetalSynth({
  volume: -15,
  envelope: { attack: 0.001, decay: 0.05, release: 0.01 },
  harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5
}).toDestination();

let prevNote = "C4";

// ===============================
// 4. éŸ³ç¨‹æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯
// ===============================
function nextNote(prev, candidates){
  const bias = 1 + activity * 4;
  let best = candidates[0];
  let bestScore = 999;
  for(const n of candidates){
    const midiPrev = Tone.Frequency(prev).toMidi();
    const midiN = Tone.Frequency(n).toMidi();
    const score = Math.abs(Math.abs(midiN - midiPrev) - bias) - (midiN/60 * heightBias);
    if(score < bestScore){ bestScore = score; best = n; }
  }
  return best;
}

// ===============================
// 5. ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
// ===============================
async function start(){
  await Tone.start();
  Tone.Transport.bpm.value = 110;

  // --- A. ã‚³ãƒ¼ãƒ‰ä¼´å¥ ---
  Tone.Transport.scheduleRepeat((time) => {
    const bar = Math.floor(Number(Tone.Transport.position.split(":")[0]) % 8);
    if(chords[bar]) chordSynth.triggerAttackRelease(chords[bar], "1n", time);
  }, "1n");

  // --- B. ãƒ¡ãƒ­ãƒ‡ã‚£ ---
  let tickCounter = 0;
  let nextNoteTick = 0;
  Tone.Transport.scheduleRepeat((time) => {
    if (tickCounter < nextNoteTick) { tickCounter++; return; }

    let step = (activity < 0.4) ? 4 : (activity > 0.7 ? 1 : 2); 
    if(Math.random() > 0.7) step *= 2; 
    
    const duration = (step >= 4) ? "4n" : "8n";

    if (Math.random() > ((activity > 0.8) ? 0.1 : 0.2)) {
      const barIdx = Math.floor(tickCounter / 16) % 8;
      if (scales[barIdx]) {
        const next = nextNote(prevNote, scales[barIdx]);
        melodySynth.triggerAttackRelease(next, duration, time);
        prevNote = next;
      }
    }
    nextNoteTick = tickCounter + step;
    tickCounter++;
  }, "16n");

  // --- C. ãƒ‰ãƒ©ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¶å¾¡ (ä¿®æ­£ç®‡æ‰€) ---
  Tone.Transport.scheduleRepeat((time) => {
    
    // ã€ã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‘
    // getTicks() ã§ã¯ãªã ticks ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ã„ã¾ã™
    // Tone.Transport.ticks : é–‹å§‹ã‹ã‚‰ã®ç·ãƒãƒƒã‚¯æ•°
    // Tone.Transport.PPQ : 4åˆ†éŸ³ç¬¦ã‚ãŸã‚Šã®ãƒãƒƒã‚¯æ•° (é€šå¸¸192)
    
    // ç¾åœ¨ã®16åˆ†éŸ³ç¬¦ã®ä½ç½® (0ã€œ15) ã‚’è¨ˆç®—
    const currentSixteenth = Math.floor(Tone.Transport.ticks / (Tone.Transport.PPQ / 4)) % 16;
    
    const s = currentSixteenth;
    let k = false; // Kick
    let n = false; // Snare
    let h = false; // Hihat

    // === ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†å² ===
    if (activity < 0.35) {
      // é™ï¼ˆå·¦ï¼‰
      if (s === 0 || s === 8) k = true;
      if (s % 4 === 0) h = true;
    } else if (activity < 0.7) {
      // æ¨™æº–ï¼ˆä¸­ï¼‰
      if (s === 0 || s === 10) k = true;
      if (s === 4 || s === 12) n = true;
      if (s % 2 === 0) h = true;
    } else {
      // æ¿€ï¼ˆå³ï¼‰
      if (s % 4 === 0) k = true;
      if (s === 4 || s === 12) n = true;
      h = true;
    }

    // === ç™ºéŸ³ ===
    if (k) kick.triggerAttackRelease("C1", "8n", time);
    if (n) snare.triggerAttackRelease("8n", time);
    if (h) {
      const vol = (s % 4 === 0) ? 1.0 : 0.3; 
      hihat.triggerAttackRelease("32n", time, vol);
    }

  }, "16n");

  Tone.Transport.start();
}

document.body.addEventListener('click', async () => {
  if (Tone.Transport.state !== 'started') await start();
});
</script>
</body>
</html>
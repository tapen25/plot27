<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motion Only Generator</title>
  <script src="https://unpkg.com/tone@latest/build/Tone.js"></script>
  <style>
    body {
      height: 100vh; margin: 0; background: #000; color: white;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      overflow: hidden;
    }
    h2 { margin-bottom: 10px; font-size: 1.5rem; letter-spacing: 2px; }
    #status { font-size: 4rem; font-weight: 800; margin: 20px 0; color: #fff; font-variant-numeric: tabular-nums;}
    #label { color: #666; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;}
    
    /* ビジュアライザー */
    .bar-container {
      width: 80%; height: 10px; background: #222; border-radius: 10px; overflow: hidden; margin-bottom: 40px;
    }
    .bar-fill {
      height: 100%; width: 0%; background: linear-gradient(90deg, #4facfe, #00f2fe);
      transition: width 0.2s ease-out;
    }

    /* ボタン */
    button {
      padding: 20px 40px; font-size: 1.2rem; cursor: pointer;
      background: #fff; color: #000; border: none; border-radius: 50px;
      font-weight: bold; box-shadow: 0 0 20px rgba(255,255,255,0.2);
      transition: transform 0.1s;
    }
    button:active { transform: scale(0.95); }
  </style>
</head>
<body>

  <div id="label">Current Tempo</div>
  <div id="status">-- BPM</div>
  
  <div class="bar-container"><div id="meter" class="bar-fill"></div></div>

  <button id="playBtn">TAP TO START</button>
  <p style="color:#555; font-size:0.8rem; margin-top:20px;">(Requires Accelerometer Permission)</p>

<script>
// ===============================
// 1. 楽曲データ (Cメジャー)
// ===============================
const chords = [
  ["C3","E3","G3"], ["B2","D3","G3"], ["A2","C3","E3"], ["G2","B2","E3"],
  ["F2","A2","C3"], ["E2","G2","C3"], ["F2","A2","C3"], ["G2","B2","D3"]
];
const scales = [
  ["C4","D4","E4","G4","A4"], ["B3","D4","G4","A4","B4"],
  ["A3","C4","E4","G4","A4"], ["G3","B3","E4","G4","B4"],
  ["F3","A3","C4","F4","G4"], ["E3","G3","C4","E4","G4"],
  ["F3","A3","C4","F4","A4"], ["G3","B3","D4","G4","A4"]
];

// ===============================
// 2. 楽器セットアップ
// ===============================
const chordSynth = new Tone.PolySynth(Tone.Synth, { volume: -10 }).toDestination();
const melodySynth = new Tone.Synth({ oscillator: { type: "triangle" }, volume: -2 }).toDestination();

// ドラム
const kick = new Tone.MembraneSynth({ volume: -4 }).toDestination();
const snare = new Tone.NoiseSynth({ volume: -12, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination();
const hihat = new Tone.MetalSynth({ volume: -15, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination();

// ===============================
// 3. センサー & 状態変数
// ===============================
const motionBuffer = [];
const DURATION = 2000; 
let sensorVariance = 0.0; 
let smoothedVariance = 0.0; 

// 音楽制御パラメータ
let activity = 0.0; // 0.0(静) 〜 1.0(動)
let prevNote = "C4";

// ===============================
// 4. センサー処理 (devicemotionのみ)
// ===============================
function handleMotion(event) {
  const a = event.accelerationIncludingGravity;
  if (!a) return;

  // ベクトルの大きさ
  const mag = Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z);
  const now = Date.now();
  
  motionBuffer.push({ t: now, m: mag });
  
  // 2秒以上前のデータを削除
  while (motionBuffer.length > 0 && motionBuffer[0].t < now - DURATION) {
    motionBuffer.shift();
  }
  
  if (motionBuffer.length < 5) {
    sensorVariance = 0;
    return;
  }

  // 分散（揺れの激しさ）を計算
  const magnitudes = motionBuffer.map(d => d.m);
  const mean = magnitudes.reduce((s, v) => s + v, 0) / magnitudes.length;
  const variance = magnitudes.reduce((s, v) => s + (v - mean) ** 2, 0) / magnitudes.length;
  
  sensorVariance = Math.sqrt(variance); 
}

// ===============================
// 5. パラメータ更新ループ
// ===============================
const statusEl = document.getElementById('status');
const meterEl = document.getElementById('meter');

function updateParameters() {
  // 値を滑らかにする (Low-pass filter)
  smoothedVariance += (sensorVariance - smoothedVariance) * 0.05;
  
  // --- A. BPM計算 ---
  // 静止(Var=0) -> 90 BPM
  // 歩行(Var=3〜5) -> 110〜120 BPM
  // 走行(Var=8以上) -> 145 BPM (Max)
  let targetBpm = 90 + (smoothedVariance * 7); 
  if (targetBpm > 145) targetBpm = 145;
  if (targetBpm < 90) targetBpm = 90;

  // Tone.jsに適用
  if(Tone.Transport.state === 'started'){
     Tone.Transport.bpm.value = targetBpm;
  }
  
  // --- B. Activity計算 (アレンジの激しさ) ---
  // 0.0 〜 1.0 に正規化
  let rawActivity = smoothedVariance / 5.0;
  if (rawActivity > 1.0) rawActivity = 1.0;
  activity = rawActivity;

  // UI更新
  statusEl.innerText = Math.floor(targetBpm) + " BPM";
  meterEl.style.width = (activity * 100) + "%";
  
  requestAnimationFrame(updateParameters);
}
updateParameters();

// ===============================
// 6. 音楽生成ロジック
// ===============================

// 音程選択アルゴリズム
function nextNote(prev, candidates){
  const bias = 1 + activity * 4; 
  let best = candidates[0];
  let bestScore = 999;
  for(const n of candidates){
    const midiPrev = Tone.Frequency(prev).toMidi();
    const midiN = Tone.Frequency(n).toMidi();
    const score = Math.abs(Math.abs(midiN - midiPrev) - bias); 
    if(score < bestScore){ bestScore = score; best = n; }
  }
  return best;
}

// メインシーケンス
function setupMusic() {
  // --- A. コード (全音符) ---
  Tone.Transport.scheduleRepeat((time) => {
    const bar = Math.floor(Number(Tone.Transport.position.split(":")[0]) % 8);
    if(chords[bar]) chordSynth.triggerAttackRelease(chords[bar], "1n", time);
  }, "1n");

  // --- B. メロディ (自動生成) ---
  let tickCounter = 0;
  let nextNoteTick = 0;
  Tone.Transport.scheduleRepeat((time) => {
    if (tickCounter < nextNoteTick) { tickCounter++; return; }

    // activityが高いほど細かい音符になる
    let step = (activity < 0.3) ? 4 : (activity > 0.7 ? 1 : 2); 
    if(Math.random() > 0.7) step *= 2; 
    
    const duration = (step >= 4) ? "4n" : "8n";

    // 音を鳴らす
    if (Math.random() > ((activity > 0.8) ? 0.1 : 0.2)) {
      const barIdx = Math.floor(tickCounter / 16) % 8;
      if (scales[barIdx]) {
        const next = nextNote(prevNote, scales[barIdx]);
        melodySynth.triggerAttackRelease(next, duration, time);
        prevNote = next;
      }
    }
    nextNoteTick = tickCounter + step;
    tickCounter++;
  }, "16n");

  // --- C. ドラム (パターン変化) ---
  Tone.Transport.scheduleRepeat((time) => {
    // 16分音符位置 (0-15)
    const s = Math.floor(Tone.Transport.ticks / (Tone.Transport.PPQ / 4)) % 16;
    
    let k=false, n=false, h=false;
    
    // パターン分岐
    if (activity < 0.25) {
      // [静止/ゆっくり] Kickのみ
      if (s === 0 || s === 8) k = true;
      if (s % 4 === 0) h = true; 
    } else if (activity < 0.6) {
      // [歩行] 8ビート (Kick, Snare)
      if (s === 0 || s === 10) k = true;
      if (s === 4 || s === 12) n = true;
      if (s % 2 === 0) h = true;
    } else {
      // [走行/ダンス] 4つ打ち + 16ビート
      if (s % 4 === 0) k = true;
      if (s === 4 || s === 12) n = true;
      h = true; 
    }

    if (k) kick.triggerAttackRelease("C1", "8n", time);
    if (n) snare.triggerAttackRelease("8n", time);
    if (h) {
      const vol = (s % 4 === 0) ? 1.0 : 0.3;
      hihat.triggerAttackRelease("32n", time, vol);
    }
  }, "16n");
}

// ===============================
// 7. 開始処理
// ===============================
const btn = document.getElementById('playBtn');
let isPlaying = false;

btn.addEventListener('click', async () => {
  if (!isPlaying) {
    await Tone.start();
    
    // iOS向け許可リクエスト
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
      try {
        const res = await DeviceMotionEvent.requestPermission();
        if (res === 'granted') {
          window.addEventListener('devicemotion', handleMotion);
        } else {
          alert("センサー許可がないとBPMが変化しません");
        }
      } catch (e) { console.error(e); }
    } else {
      // Android / PC
      window.addEventListener('devicemotion', handleMotion);
    }

    setupMusic();
    Tone.Transport.start();
    isPlaying = true;
    btn.innerText = "STOP";
    btn.style.background = "#ff4444";
    btn.style.color = "#fff";
    
  } else {
    Tone.Transport.stop();
    Tone.Transport.cancel();
    window.removeEventListener('devicemotion', handleMotion);
    isPlaying = false;
    btn.innerText = "TAP TO START";
    btn.style.background = "#fff";
    btn.style.color = "#000";
    
    // リセット
    sensorVariance = 0;
    smoothedVariance = 0;
    activity = 0;
    statusEl.innerText = "-- BPM";
    meterEl.style.width = "0%";
  }
});
</script>
</body>
</html>
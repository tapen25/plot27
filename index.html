<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motion Music Player</title>
  <script src="https://unpkg.com/tone@latest/build/Tone.js"></script>
  <style>
    body {
      height: 100vh; margin: 0; background: #000; color: #fff;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-family: monospace; overflow: hidden; text-align: center;
    }
    #val-display { font-size: 3rem; font-weight: bold; margin: 10px 0; color: #0ff;}
    #label { color: #888; margin-top: 20px; font-size: 0.8rem;}
    
    .meter-box {
      width: 80%; height: 10px; background: #333; border-radius: 5px; 
      margin-bottom: 30px; overflow: hidden;
    }
    .meter-bar {
      height: 100%; width: 0%; background: linear-gradient(90deg, #0ff, #f0f);
      transition: width 0.1s linear;
    }

    button {
      padding: 20px 40px; font-size: 1.2rem; background: #fff; color: #000;
      border: none; border-radius: 50px; font-weight: bold; cursor: pointer;
      margin-top: 10px;
    }
    #debug-log {
      font-size: 0.7rem; color: #ffff00; margin-top: 20px; max-width: 90%;
    }
  </style>
</head>
<body>

  <div id="label">StdDev (2s Window)</div>
  <div id="val-display">0.00</div>
  
  <div class="meter-box"><div id="meter" class="meter-bar"></div></div>
  <div id="bpm-label" style="color:#aaa; margin-bottom:20px;">BPM: --</div>

  <button id="playBtn">START / PERMISSION</button>
  
  <div id="debug-log">※HTTPS接続が必要です</div>

<script>
// ===============================
// 1. 楽曲データ
// ===============================
const chords = [
  ["C3","E3","G3"], ["B2","D3","G3"], ["A2","C3","E3"], ["G2","B2","E3"],
  ["F2","A2","C3"], ["E2","G2","C3"], ["F2","A2","C3"], ["G2","B2","D3"]
];
const scales = [
  ["C4","D4","E4","G4","A4"], ["B3","D4","G4","A4","B4"],
  ["A3","C4","E4","G4","A4"], ["G3","B3","E4","G4","B4"],
  ["F3","A3","C4","F4","G4"], ["E3","G3","C4","E4","G4"],
  ["F3","A3","C4","F4","A4"], ["G3","B3","D4","G4","A4"]
];

// ===============================
// 2. 音源
// ===============================
const chordSynth = new Tone.PolySynth(Tone.Synth, { volume: -10 }).toDestination();
const melodySynth = new Tone.Synth({ oscillator: { type: "triangle" }, volume: -2 }).toDestination();
const kick = new Tone.MembraneSynth({ volume: -4 }).toDestination();
const snare = new Tone.NoiseSynth({ volume: -12, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination();
const hihat = new Tone.MetalSynth({ volume: -15, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination();

let prevNote = "C4";

// ===============================
// 3. センサー処理ロジック
// ===============================
const motionBuffer = [];
const WINDOW_MS = 2000; 
let currentStdDev = 0.0; 
let targetBpm = 90;
let activity = 0.0;

function handleMotion(event) {
  let x, y, z;
  // 重力抜き加速度を優先、なければ重力込み
  if (event.acceleration && event.acceleration.x !== null) {
    x = event.acceleration.x; y = event.acceleration.y; z = event.acceleration.z;
  } else {
    const acc = event.accelerationIncludingGravity;
    x = acc.x; y = acc.y; z = acc.z;
  }

  const mag = Math.sqrt(x*x + y*y + z*z);
  const now = Date.now();
  motionBuffer.push({ t: now, val: mag });

  // 2秒ウィンドウ
  while (motionBuffer.length > 0 && motionBuffer[0].t < now - WINDOW_MS) {
    motionBuffer.shift();
  }

  if (motionBuffer.length > 5) {
    const values = motionBuffer.map(d => d.val);
    const n = values.length;
    const mean = values.reduce((a, b) => a + b, 0) / n;
    const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
    currentStdDev = Math.sqrt(variance);
  } else {
    currentStdDev = 0;
  }
}

// ===============================
// 4. ループ & 描画
// ===============================
const valDisplay = document.getElementById('val-display');
const meterBar = document.getElementById('meter');
const bpmLabel = document.getElementById('bpm-label');
let smoothedStdDev = 0.0;

function loop() {
  requestAnimationFrame(loop);

  // 値のスムージング
  smoothedStdDev += (currentStdDev - smoothedStdDev) * 0.1;
  
  // Activity計算 (0.0 - 1.0)
  // 通常の歩行でStdDevは 2.0〜4.0 程度
  activity = smoothedStdDev / 5.0;
  if (activity > 1.0) activity = 1.0;

  // BPM計算
  let bpm = 90 + (smoothedStdDev * 15);
  if (bpm > 160) bpm = 160;
  if (bpm < 90) bpm = 90;
  targetBpm = bpm;

  if (Tone.Transport.state === 'started') {
    Tone.Transport.bpm.value = targetBpm;
  }

  // 表示更新
  valDisplay.innerText = smoothedStdDev.toFixed(2);
  meterBar.style.width = (activity * 100) + "%";
  bpmLabel.innerText = "BPM: " + Math.round(targetBpm);
}
loop();

// ===============================
// 5. 音楽生成ロジック
// ===============================
function nextNote(prev, candidates){
  const bias = 1 + activity * 5; 
  let best = candidates[0];
  let bestScore = 999;
  for(const n of candidates){
    const midiPrev = Tone.Frequency(prev).toMidi();
    const midiN = Tone.Frequency(n).toMidi();
    const score = Math.abs(Math.abs(midiN - midiPrev) - bias);
    if(score < bestScore){ bestScore = score; best = n; }
  }
  return best;
}

function setupMusic() {
  // コード
  Tone.Transport.scheduleRepeat((time) => {
    const bar = Math.floor(Number(Tone.Transport.position.split(":")[0]) % 8);
    if(chords[bar]) chordSynth.triggerAttackRelease(chords[bar], "1n", time);
  }, "1n");

  // メロディ
  let tickCounter = 0;
  let nextNoteTick = 0;
  Tone.Transport.scheduleRepeat((time) => {
    if (tickCounter < nextNoteTick) { tickCounter++; return; }
    let step = (activity < 0.2) ? 4 : (activity > 0.6 ? 1 : 2);
    if(Math.random() > 0.7) step *= 2; 
    const duration = (step >= 4) ? "4n" : "8n";
    const density = (activity > 0.8) ? 0.9 : 0.7;
    if (Math.random() < density) {
      const barIdx = Math.floor(tickCounter / 16) % 8;
      if (scales[barIdx]) {
        const next = nextNote(prevNote, scales[barIdx]);
        melodySynth.triggerAttackRelease(next, duration, time);
        prevNote = next;
      }
    }
    nextNoteTick = tickCounter + step;
    tickCounter++;
  }, "16n");

  // ドラム
  Tone.Transport.scheduleRepeat((time) => {
    const s = Math.floor(Tone.Transport.ticks / (Tone.Transport.PPQ / 4)) % 16;
    let k=false, n=false, h=false;
    if (activity < 0.3) {
      if (s === 0 || s === 8) k = true;
      if (s % 4 === 0) h = true;
    } else if (activity < 0.7) {
      if (s === 0 || s === 10) k = true;
      if (s === 4 || s === 12) n = true;
      if (s % 2 === 0) h = true;
    } else {
      if (s % 4 === 0) k = true;
      if (s === 4 || s === 12) n = true;
      h = true; 
    }
    if (k) kick.triggerAttackRelease("C1", "8n", time);
    if (n) snare.triggerAttackRelease("8n", time);
    if (h) {
      const vol = (s % 4 === 0) ? 1.0 : 0.3;
      hihat.triggerAttackRelease("32n", time, vol);
    }
  }, "16n");
}

// ===============================
// 6. センサー許可 & 再生開始処理
// ===============================
const playBtn = document.getElementById('playBtn');
const debugLog = document.getElementById('debug-log');
let isPlaying = false;

// ★ iOS 13+ センサー許可関数
async function startSensor() {
  // DeviceMotionEventが存在するか
  if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
    // iOS 13+ の場合
    try {
      const permission = await DeviceMotionEvent.requestPermission();
      if (permission === 'granted') {
        window.addEventListener('devicemotion', handleMotion);
        debugLog.innerText = "iOS Sensor: GRANTED";
        return true;
      } else {
        alert("センサー許可が拒否されました。\nブラウザの設定を確認してリロードしてください。");
        debugLog.innerText = "iOS Sensor: DENIED";
        return false;
      }
    } catch (e) {
      console.error(e);
      debugLog.innerText = "iOS Error: " + e.message;
      alert("エラー: " + e.message);
      return false;
    }
  } else {
    // Android / PC (許可不要)
    window.addEventListener('devicemotion', handleMotion);
    debugLog.innerText = "Sensor: Ready (Non-iOS)";
    return true;
  }
}

playBtn.addEventListener('click', async () => {
  if (!isPlaying) {
    // 1. Tone.js開始
    await Tone.start();
    console.log("Audio started");

    // 2. センサー許可リクエスト (ここが重要！)
    const sensorReady = await startSensor();
    
    if (sensorReady) {
      setupMusic();
      Tone.Transport.start();
      isPlaying = true;
      playBtn.innerText = "STOP";
      playBtn.style.background = "#f0f";
      playBtn.style.color = "#fff";
    }

  } else {
    // 停止処理
    Tone.Transport.stop();
    Tone.Transport.cancel();
    window.removeEventListener('devicemotion', handleMotion);
    isPlaying = false;
    playBtn.innerText = "START";
    playBtn.style.background = "#fff";
    playBtn.style.color = "#000";
    
    // リセット
    motionBuffer.length = 0;
    currentStdDev = 0;
    valDisplay.innerText = "0.00";
    debugLog.innerText = "Stopped.";
  }
});
</script>
</body>
</html>
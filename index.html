<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Motion StdDev Player</title>
  <script src="https://unpkg.com/tone@latest/build/Tone.js"></script>
  <style>
    body {
      height: 100vh; margin: 0; background: #000; color: #fff;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-family: monospace; overflow: hidden;
    }
    #val-display { font-size: 4rem; font-weight: bold; margin: 10px 0; color: #0ff;}
    #label { color: #888; margin-top: 20px; font-size: 0.9rem;}
    
    .meter-box {
      width: 80%; height: 10px; background: #333; border-radius: 5px; 
      margin-bottom: 30px; overflow: hidden;
    }
    .meter-bar {
      height: 100%; width: 0%; background: linear-gradient(90deg, #0ff, #f0f);
      transition: width 0.1s linear;
    }

    button {
      padding: 20px 40px; font-size: 1.2rem; background: #fff; color: #000;
      border: none; border-radius: 50px; font-weight: bold; cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="label">INTENSITY (StdDev)</div>
  <div id="val-display">0.00</div>
  
  <div class="meter-box"><div id="meter" class="meter-bar"></div></div>
  <div id="bpm-label" style="color:#aaa; margin-bottom:20px;">BPM: --</div>

  <button id="playBtn">TAP TO START</button>

<script>
// ===============================
// 1. 楽曲データ (カノン進行 C Major)
// ===============================
const chords = [
  ["C3","E3","G3"], ["B2","D3","G3"], ["A2","C3","E3"], ["G2","B2","E3"],
  ["F2","A2","C3"], ["E2","G2","C3"], ["F2","A2","C3"], ["G2","B2","D3"]
];
const scales = [
  ["C4","D4","E4","G4","A4"], ["B3","D4","G4","A4","B4"],
  ["A3","C4","E4","G4","A4"], ["G3","B3","E4","G4","B4"],
  ["F3","A3","C4","F4","G4"], ["E3","G3","C4","E4","G4"],
  ["F3","A3","C4","F4","A4"], ["G3","B3","D4","G4","A4"]
];

// ===============================
// 2. 楽器セットアップ
// ===============================
const chordSynth = new Tone.PolySynth(Tone.Synth, { volume: -10 }).toDestination();
const melodySynth = new Tone.Synth({ oscillator: { type: "triangle" }, volume: -2 }).toDestination();
const kick = new Tone.MembraneSynth({ volume: -4 }).toDestination();
const snare = new Tone.NoiseSynth({ volume: -12, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination();
const hihat = new Tone.MetalSynth({ volume: -15, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination();

let prevNote = "C4";

// ===============================
// 3. 加速度センサー計算ロジック (標準偏差)
// ===============================
const motionBuffer = [];
const WINDOW_MS = 2000; // 直近2秒分
let currentStdDev = 0.0; // 計算された標準偏差（揺れ強度）

// 音楽制御用パラメータ
let targetBpm = 90;
let activity = 0.0;

function handleMotion(event) {
  let x, y, z;

  // 1. 重力抜きの加速度 (acceleration) を取得試行
  if (event.acceleration && event.acceleration.x !== null) {
    x = event.acceleration.x;
    y = event.acceleration.y;
    z = event.acceleration.z;
  } else {
    // 2. 非対応なら重力込み (accelerationIncludingGravity) を使用
    // ※標準偏差を取るため、重力（定数成分）は計算過程で自動的に相殺されます
    const acc = event.accelerationIncludingGravity;
    x = acc.x;
    y = acc.y;
    z = acc.z;
  }

  // ベクトルの大きさ (Magnitude)
  const mag = Math.sqrt(x*x + y*y + z*z);
  const now = Date.now();

  // バッファに追加
  motionBuffer.push({ t: now, val: mag });

  // 2秒以上前のデータを削除 (FIFO)
  while (motionBuffer.length > 0 && motionBuffer[0].t < now - WINDOW_MS) {
    motionBuffer.shift();
  }

  // --- 標準偏差 (Standard Deviation) の計算 ---
  if (motionBuffer.length > 5) {
    const values = motionBuffer.map(d => d.val);
    const n = values.length;
    
    // 平均 (Mean)
    const mean = values.reduce((a, b) => a + b, 0) / n;
    
    // 分散 (Variance)
    const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
    
    // 標準偏差
    currentStdDev = Math.sqrt(variance);
  } else {
    currentStdDev = 0;
  }
}

// ===============================
// 4. メインループ (パラメータ適用)
// ===============================
const valDisplay = document.getElementById('val-display');
const meterBar = document.getElementById('meter');
const bpmLabel = document.getElementById('bpm-label');
let smoothedStdDev = 0.0;

function updateParams() {
  // 値の急激な変化を抑える（スムージング）
  smoothedStdDev += (currentStdDev - smoothedStdDev) * 0.1;

  // --- マッピング ---
  // 標準偏差はおよそ 0 (静止) 〜 5.0以上 (激しい揺れ) くらいの値になります
  
  // 1. BPM計算 (基準90 + 揺れ*12)
  let bpm = 90 + (smoothedStdDev * 12);
  if (bpm > 160) bpm = 160; // 上限
  if (bpm < 90) bpm = 90;   // 下限
  targetBpm = bpm;

  if (Tone.Transport.state === 'started') {
    Tone.Transport.bpm.value = targetBpm;
  }

  // 2. Activity計算 (0.0 〜 1.0)
  activity = smoothedStdDev / 4.0;
  if (activity > 1.0) activity = 1.0;

  // --- UI更新 ---
  valDisplay.innerText = smoothedStdDev.toFixed(2);
  meterBar.style.width = (activity * 100) + "%";
  bpmLabel.innerText = "BPM: " + Math.round(targetBpm);

  requestAnimationFrame(updateParams);
}
updateParams();

// ===============================
// 5. 音楽生成 (カノン進行固定)
// ===============================

// 音程決定ロジック
function nextNote(prev, candidates){
  // 揺れが大きいほど音程が飛びやすくなるバイアス
  const bias = 1 + activity * 5; 
  let best = candidates[0];
  let bestScore = 999;
  
  for(const n of candidates){
    const midiPrev = Tone.Frequency(prev).toMidi();
    const midiN = Tone.Frequency(n).toMidi();
    // 前の音との距離が、現在の「勢い(bias)」に近いものを選ぶ
    const score = Math.abs(Math.abs(midiN - midiPrev) - bias);
    if(score < bestScore){ bestScore = score; best = n; }
  }
  return best;
}

function setupMusic() {
  // A. コード進行 (全音符)
  Tone.Transport.scheduleRepeat((time) => {
    const bar = Math.floor(Number(Tone.Transport.position.split(":")[0]) % 8);
    if(chords[bar]) chordSynth.triggerAttackRelease(chords[bar], "1n", time);
  }, "1n");

  // B. メロディ (Activityに応じて細かくなる)
  let tickCounter = 0;
  let nextNoteTick = 0;
  
  Tone.Transport.scheduleRepeat((time) => {
    if (tickCounter < nextNoteTick) { tickCounter++; return; }

    // 揺れ小: 4分音符主体 / 揺れ大: 16分音符主体
    let step = (activity < 0.2) ? 4 : (activity > 0.6 ? 1 : 2);
    // ランダム性
    if(Math.random() > 0.7) step *= 2; 
    
    const duration = (step >= 4) ? "4n" : "8n";

    // 音を鳴らす判定
    const density = (activity > 0.8) ? 0.9 : 0.7; // 激しいときは休符少なめ
    if (Math.random() < density) {
      const barIdx = Math.floor(tickCounter / 16) % 8;
      if (scales[barIdx]) {
        const next = nextNote(prevNote, scales[barIdx]);
        melodySynth.triggerAttackRelease(next, duration, time);
        prevNote = next;
      }
    }
    nextNoteTick = tickCounter + step;
    tickCounter++;
  }, "16n");

  // C. ドラム (Activityに応じてパターン変化)
  Tone.Transport.scheduleRepeat((time) => {
    const s = Math.floor(Tone.Transport.ticks / (Tone.Transport.PPQ / 4)) % 16;
    let k=false, n=false, h=false;

    // パターン定義
    if (activity < 0.3) {
      // [静] キックのみ (心音風)
      if (s === 0 || s === 8) k = true;
      if (s % 4 === 0) h = true;
    } else if (activity < 0.7) {
      // [中] 8ビート
      if (s === 0 || s === 10) k = true;
      if (s === 4 || s === 12) n = true;
      if (s % 2 === 0) h = true;
    } else {
      // [動] 4つ打ちダンス
      if (s % 4 === 0) k = true;
      if (s === 4 || s === 12) n = true;
      h = true; // 16分ハイハット
    }

    if (k) kick.triggerAttackRelease("C1", "8n", time);
    if (n) snare.triggerAttackRelease("8n", time);
    if (h) {
      const vol = (s % 4 === 0) ? 1.0 : 0.3;
      hihat.triggerAttackRelease("32n", time, vol);
    }
  }, "16n");
}

// ===============================
// 6. 開始ボタン
// ===============================
const btn = document.getElementById('playBtn');
let isPlaying = false;

btn.addEventListener('click', async () => {
  if (!isPlaying) {
    await Tone.start();
    
    // iOS 13+ 対策
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
      try {
        const res = await DeviceMotionEvent.requestPermission();
        if (res === 'granted') window.addEventListener('devicemotion', handleMotion);
      } catch (e) { console.error(e); }
    } else {
      window.addEventListener('devicemotion', handleMotion);
    }

    setupMusic();
    Tone.Transport.start();
    isPlaying = true;
    btn.innerText = "STOP";
    btn.style.background = "#f0f";
    btn.style.color = "#fff";
  } else {
    Tone.Transport.stop();
    Tone.Transport.cancel();
    window.removeEventListener('devicemotion', handleMotion);
    isPlaying = false;
    btn.innerText = "TAP TO START";
    btn.style.background = "#fff";
    btn.style.color = "#000";
    
    // リセット
    motionBuffer.length = 0;
    currentStdDev = 0;
    valDisplay.innerText = "0.00";
    meterBar.style.width = "0%";
    bpmLabel.innerText = "BPM: --";
  }
});
</script>
</body>
</html>